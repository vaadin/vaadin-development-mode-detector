<!-- MAGI REMOVE START -->
<link rel="import" href="../polymer/lib/utils/import-href.html">
<!-- MAGI REMOVE END -->
<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="vaadin-development-mode-detector">
  <script>
    (function(){
      const version = window['Polymer'] && window['Polymer'].version;

      const IS_V2 = version && version.indexOf('2') === 0;

      const CHECK_UNBUNDLED_MIN_LENGTH = 200;

      if (!window.Vaadin) {
        window['Vaadin'] = {};
      }

      function endsWith(string, ending) {
        return string.lastIndexOf(ending) == string.length - ending.length;
      }

      function getHtmlImports(scope, htmlImports) {
        if (scope) {
          const imports = [...scope.querySelectorAll("link[rel=import]")];
          imports.forEach(function(link) {
            if (htmlImports.indexOf(link.href) == -1) {
              htmlImports.push(link.href);
              getHtmlImports(link.import, htmlImports)
            }
          });
        }
        return htmlImports;
      }

      class DevelopmentModeDetector extends Polymer.Element {
        
        __checkUnbundled() {// The string length of this function is used for detecting whether the app is bundled
          // NOTE: above comment is intentional, see https://github.com/Polymer/tools/issues/389
        }

        static get is() {
          return "vaadin-development-mode-detector";
        }

        get isForcedDevelopmentMode() {
          return localStorage.getItem("vaadin.developmentmode.force");
        }

        get isLocalhost() {
          return (["localhost","127.0.0.1"].indexOf(window.location.hostname) >= 0);
        }

        get isUnbundled() {
          if (IS_V2) {
            // If the app is bundled, then polymer.html should be included in some bundle and not in `polymer/polymer.html`
            const htmlImports = getHtmlImports(document, []);
            return htmlImports.filter(href => endsWith(href, "polymer/polymer-element.html")).length > 0;
          } else {
            return this.__checkUnbundled.toString().length >= CHECK_UNBUNDLED_MIN_LENGTH;
          }
        }

        get isFlowProductionMode() {
          if (window.Vaadin && window.Vaadin.Flow && window.Vaadin.Flow.clients) {
            const productionModeApps = Object.keys(window.Vaadin.Flow.clients)
            .map(key => window.Vaadin.Flow.clients[key])
            .filter(client => client.productionMode);
            if (productionModeApps.length > 0) {
              return true;
            }
          }
          return false;
        }

        get isDevelopmentMode() {
          return this.isForcedDevelopmentMode || (this.isLocalhost && this.isUnbundled && !this.isFlowProductionMode);
        }

        _runCallback(id, optionalArgument) {
          if (window.Vaadin && window.Vaadin.developmentModeCallback) {
            const callback = window.Vaadin.developmentModeCallback[id];
            if (callback) {
              callback(optionalArgument);
            }
          }
        }

        importAndRun(id, optionalArgument) {
          let path = "../" + id + "/" + id + ".html";
          /* MAGI REMOVE START */
          return Polymer.importHref(path, () => {
            this._runCallback(id, optionalArgument);
          }, null, true);
          /* MAGI REMOVE END */
        }

        loadAndRun(id, optionalArgument) {
          // magi: import('./vaadin-development-mode-detector.js'); // Enable dynamic imports
          const resolve = () => this._runCallback(id, optionalArgument);
          const path = `../${id}/${id}.js`;
          try {
            eval(`
              import('${path}')
                .then(resolve)
            `);
          } catch(e) {
            try {
              eval(`
                if (_require && _require.default) {
                  _require.default(['${path}'], resolve);
                }
              `)
            } catch(e2) {
              // Couldn't load the script, ignore
            }
          }
        }

      }

      customElements.define(DevelopmentModeDetector.is, DevelopmentModeDetector);

      const detector = document.createElement('vaadin-development-mode-detector');
      DevelopmentModeDetector.instance = detector;

      if (typeof window.Vaadin.developmentMode === "undefined") {
        try {
          window.Vaadin.developmentMode = detector.isDevelopmentMode;
        } catch (e) {
          // Some error in this code, assume production so no further actions will be taken
          window.Vaadin.developmentMode = false;
        }

        window.Vaadin.runIfDevelopmentMode = function(id, optionalArgument) {
          // Imports a HTML file named "id"/id".html and
          // triggers a callback defined in window.Vaadin.developmentModeCallback (if present)
          // with the given (optional) argument
          if (!window.Vaadin.developmentMode) {
            return;
          }

          if (window.HTMLImports && IS_V2) {
            HTMLImports.whenReady(function() {
              detector.importAndRun(id, optionalArgument);
            });
          } else if (IS_V2) {
            detector.importAndRun(id, optionalArgument);
          } else {
            detector.loadAndRun(id, optionalArgument);
          }
        }
      }
    })();
  </script>
</dom-module>
